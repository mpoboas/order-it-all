<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Search Dropdown</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7.22.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // Debounce function to limit API calls
        function debounce(func, delay) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func(...args), delay);
            };
        }

        // Product Dropdown Component
        function ProductDropdown({ products, onSelect }) {
            if (!products || products.length === 0) return null;

            return (
                <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-96 overflow-y-auto">
                    {products.map(product => (
                        <div
                            key={product.id || product.code || product.name}
                            className="flex items-center p-3 hover:bg-gray-100 cursor-pointer"
                            onClick={() => onSelect(product)}
                        >
                            <img
                                src={product.imageURL || product.image || 'https://via.placeholder.com/64'}
                                alt={product.name}
                                className="w-16 h-16 object-contain mr-4"
                                onError={(e) => { e.target.onerror = null; e.target.src = 'https://via.placeholder.com/64'; }}
                            />
                            <div>
                                <div className="font-semibold">{product.name}</div>
                                <div className="text-sm text-gray-600">Brand: {product.marca || product.brand || 'N/A'}</div>
                                <div className="text-sm text-gray-600">Capacity: {product.capacity || product.capacidade || 'N/A'}</div>
                                <div className="text-sm text-gray-600">
                                    Price: {
                                        product.pricePerUnitContinente ||
                                        product.pricePerUnitPingoDoce ||
                                        product.pricePerUnitAuchan ||
                                        product.price ||
                                        'N/A'
                                    }
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        // Main App Component
        function App() {
            const [searchTerm, setSearchTerm] = React.useState('');
            const [products, setProducts] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState(null);

            // Debounced API call
            const fetchProducts = React.useCallback(
                debounce(async (query) => {
                    if (!query.trim()) {
                        setProducts([]);
                        setError(null);
                        return;
                    }
                    setIsLoading(true);
                    setError(null);
                    try {
                        const response = await fetch(`https://supersave.pt/web/api/newLastStateCall.php?search=${encodeURIComponent(query)}`);
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        // Defensive: data.products may be undefined or not an array
                        setProducts(Array.isArray(data.products) ? data.products : []);
                    } catch (err) {
                        setError('Failed to fetch products');
                        setProducts([]);
                    } finally {
                        setIsLoading(false);
                    }
                }, 300),
                []
            );

            // Handle input change
            const handleInputChange = (e) => {
                const value = e.target.value;
                setSearchTerm(value);
                fetchProducts(value);
            };

            // Handle product selection
            const handleSelect = (product) => {
                setSearchTerm(product.name);
                setProducts([]);
                // You can add logic to add product to order here
                // For now, just log
                console.log('Selected product:', product);
            };

            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="w-full max-w-md">
                        <h1 className="text-2xl font-bold mb-4">Add Product to Order</h1>
                        <div className="relative">
                            <input
                                type="text"
                                value={searchTerm}
                                onChange={handleInputChange}
                                placeholder="Search for products..."
                                className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                autoComplete="off"
                            />
                            {isLoading && (
                                <div className="absolute right-3 top-3">
                                    <svg className="animate-spin h-5 w-5 text-gray-500" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8h8a8 8 0 01-16 0z" />
                                    </svg>
                                </div>
                            )}
                            <ProductDropdown products={products} onSelect={handleSelect} />
                        </div>
                        {error && <div className="mt-2 text-red-500">{error}</div>}
                    </div>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
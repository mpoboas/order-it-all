<!DOCTYPE html>
<html lang="pt-PT" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divisor - Order It All!</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- PocketBase SDK -->
    <script src="https://unpkg.com/pocketbase@0.21.1/dist/pocketbase.umd.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f8fc;
            min-height: 100dvh;
        }
        
        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
        
        /* Modern gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        /* Card styling */
        .modern-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .modern-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }
        
        /* Table styling - Less boxy, more modern */
        .table-container {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
        }
        
        .table-header {
            padding: 16px 20px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: none;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        .table-cell {
            padding: 20px;
            white-space: nowrap;
            font-size: 15px;
            color: #1f2937;
            border: none;
            background: white;
            transition: all 0.3s ease;
        }
        
        .table-row:hover .table-cell {
            background: linear-gradient(135deg, #f8fafc 0%, #f0f9ff 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .table-cell-center {
            text-align: center;
        }
        
        .table-cell-right {
            text-align: right;
        }
        
        .total-row {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            font-weight: 600;
            border: none;
            position: sticky;
            bottom: 0;
            z-index: 5;
        }
        
        .total-row .table-cell {
            background: transparent;
            color: white;
            border: none;
        }
        
        .checkbox-custom {
            height: 22px;
            width: 22px;
            color: #6366f1;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .checkbox-custom:hover {
            border-color: #6366f1;
            transform: scale(1.1);
        }
        
        .checkbox-custom:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .checkbox-custom:checked {
            background-color: #6366f1;
            border-color: #6366f1;
            transform: scale(1.05);
        }
        
        .add-button {
            color: #9ca3af;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 12px;
            border-radius: 12px;
            background: transparent;
            border: 2px dashed #e2e8f0;
        }
        
        .add-button:hover {
            color: #6366f1;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
        }
        
        .add-button-participant {
            width: 100%;
            min-height: 50px;
            border-radius: 16px;
            font-weight: 500;
        }
        
        /* Modern buttons */
        .btn-modern {
            background: white;
            border: none;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary-modern {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-primary-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
        }
        
        .btn-secondary-modern {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-secondary-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        .btn-danger-modern {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-danger-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        
        /* Loading animation */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 1rem;
            z-index: 1000;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Modal styling */
        .modal-modern {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Form styling */
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Avatar styling */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .table-cell {
                padding: 12px 8px;
                font-size: 13px;
            }
            
            .table-header {
                padding: 10px 8px;
                font-size: 11px;
            }
        }
        
        /* Editable input styling - More refined */
        .editable-input {
            background: transparent;
            border: 2px solid transparent;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: inherit;
            color: inherit;
            font-weight: inherit;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .editable-input:hover {
            background: rgba(99, 102, 241, 0.05);
            border-color: rgba(99, 102, 241, 0.2);
        }
        
        .editable-input:focus {
            outline: none;
            border-color: #6366f1;
            background: white;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }
        
        .editable-input::placeholder {
            color: #9ca3af;
            opacity: 1;
        }
        
        .price-input {
            text-align: right;
            font-family: 'Inter', sans-serif;
            font-variant-numeric: tabular-nums;
        }
        
        .participant-header {
            position: sticky;
            top: 0;
            z-index: 2;
            min-width: 120px;
        }
        
        .participant-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .participant-header:hover .participant-remove {
            opacity: 1;
        }
        
        .participant-remove:hover {
            background: #ef4444;
            color: white;
            transform: scale(1.1);
        }

        /* Sticky first column */
        .sticky-col-left {
            position: sticky;
            left: 0;
            z-index: 3;
            background: white;
        }
        .sticky-col-left.table-header {
            z-index: 4;
        }
        
        .item-remove {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: none;
            border-radius: 10px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .item-remove:hover {
            background: #ef4444;
            color: white;
            transform: scale(1.05);
        }
        
        /* Split card styling */
        .split-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .split-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="w-16 h-16 border-4 border-white border-t-transparent rounded-full loading-spinner mx-auto"></div>
            <p class="mt-6 text-xl font-light">A carregar Divisor...</p>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="min-h-screen gradient-bg flex items-center justify-center p-4 hidden">
        <div class="text-center text-white max-w-md w-full">
            <div class="mb-8">
                <div class="text-6xl mb-4">💰</div>
                <h1 class="text-4xl font-bold mb-4">Divisor</h1>
                <p class="text-xl opacity-90">Acaba com as discussões!</p>
            </div>
            
            <div class="bg-white/20 backdrop-blur-md rounded-3xl p-8">
                <h2 class="text-2xl font-semibold mb-6">Começar</h2>
                <div class="space-y-4">
                    <input 
                        type="text" 
                        id="user-name-input" 
                        placeholder="Introduza o seu nome" 
                        class="w-full px-6 py-4 rounded-2xl bg-white/20 border border-white/30 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50"
                    />
                    <button id="start-btn" class="w-full py-4 bg-white text-purple-600 rounded-2xl font-semibold hover:bg-white/90 transition-all duration-300">
                        Começar a Dividir! 💸
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="min-h-screen hidden">
        <!-- Header -->
        <header class="gradient-bg text-white p-6 top-0 z-40">
            <div class="container mx-auto flex items-center justify-between">
                <div class="flex items-center">
                    <span class="material-icons text-3xl mr-3">calculate</span>
                    <div>
                        <h1 class="text-2xl font-bold">Divisor</h1>
                        <p class="text-sm opacity-90">Acaba com as discussões!</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <a href="index.html" class="btn-modern w-12 h-12 flex items-center justify-center bg-white/20 hover:bg-white/30 border border-white/30">
                        <span class="material-icons text-white">home</span>
                    </a>
                    <div class="avatar" id="user-avatar">?</div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Splits List View -->
            <div id="splits-list-view" class="container mx-auto p-6">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Divisões</h2>
                        <p class="text-gray-500">Gere e cria divisões de despesas</p>
                    </div>
                    <button id="create-split-btn" class="btn-primary-modern flex items-center">
                        <span class="material-icons mr-2">add</span>
                        Nova Divisão
                    </button>
                </div>
                
                <div id="splits-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Splits will be loaded here -->
                </div>

                <div id="no-splits" class="text-center py-16 hidden">
                    <div class="text-6xl mb-4">💰</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Ainda sem divisões</h3>
                    <p class="text-gray-600">Cria a tua primeira divisão de despesas para começar!</p>
                </div>
            </div>

            <!-- Split Detail View -->
            <div id="split-detail-view" class="hidden">
                <div class="container mx-auto px-4 pt-4 pb-2">
                    <!-- Mobile Header -->
                    <div class="flex items-start mb-4 md:mb-6">
                        <button id="back-to-splits" class="btn-modern w-10 h-10 md:w-12 md:h-12 mr-3 flex-shrink-0 mt-1">
                            <span class="material-icons text-gray-600 text-xl md:text-2xl">arrow_back</span>
                        </button>
                        <div class="flex-1 min-w-0">
                            <input type="text" id="split-name" 
                                   class="block w-full text-xl md:text-2xl font-bold text-gray-900 bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-2 py-1 mb-2" 
                                   placeholder="Nome da Divisão">
                            <input type="text" id="split-description" 
                                   class="block w-full text-sm md:text-base text-gray-500 bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-2 py-1" 
                                   placeholder="Descrição (opcional)">
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-2 mb-4 md:justify-end">
                        <button id="save-split-btn" class="btn-primary-modern flex-1 md:flex-none flex items-center justify-center py-3 md:py-2">
                            <span class="material-icons mr-2 text-lg">save</span>
                            <span class="font-medium">Guardar</span>
                        </button>
                        <button id="delete-split-btn" class="btn-danger-modern flex-1 md:flex-none flex items-center justify-center py-3 md:py-2">
                            <span class="material-icons mr-2 text-lg">delete</span>
                            <span class="font-medium">Eliminar</span>
                        </button>
                    </div>
                </div>

                <!-- Mobile Participants Management - Hidden on Desktop -->
                <div class="md:hidden px-4">
                    <div class="bg-white rounded-xl shadow p-4">
                        <div class="flex items-center justify-between cursor-pointer" onclick="SplitTableManager.toggleMobileParticipants()">
                            <div class="flex items-center">
                                <h3 class="text-lg font-semibold text-gray-900">Participantes</h3>
                                <span id="mobile-participants-count" class="ml-2 text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded-full">0</span>
                            </div>
                            <span id="mobile-participants-toggle-icon" class="material-icons text-gray-400">expand_more</span>
                        </div>
                        <div id="mobile-participants-content" class="hidden mt-3">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm text-gray-600">Gerir pessoas nesta divisão</span>
                                <button onclick="SplitTableManager.addParticipant()" class="btn-primary-modern text-sm px-3 py-2 flex items-center">
                                    <span class="material-icons text-sm mr-1">person_add</span>
                                    Adicionar Pessoa
                                </button>
                            </div>
                            <div id="mobile-participants-list" class="flex flex-wrap gap-2">
                                <!-- Participant chips will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Desktop Table - Hidden on Mobile -->
                <div class="hidden md:block w-full px-4 py-6">
                    <div class="table-container modern-card relative">
                        <div id="split-table-wrapper" class="overflow-x-auto max-h-[70vh] overflow-y-auto">
                            <table class="min-w-full">
                                <thead id="split-table-head">
                                    <!-- Table header will be generated here -->
                                </thead>
                                <tbody id="split-table-body" class="divide-y divide-gray-100">
                                    <!-- Table body will be generated here -->
                                </tbody>
                                <tfoot id="split-table-foot">
                                    <!-- Table footer will be generated here -->
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Cards - Hidden on Desktop -->
                <div class="md:hidden px-4 py-6 pb-24">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Itens</h3>
                        <span id="mobile-items-count" class="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded-full">0</span>
                    </div>
                    <div id="mobile-items-container" class="space-y-4">
                        <!-- Mobile item cards will be generated here -->
                    </div>
                    
                    <!-- Add Item Button for Mobile -->
                    <button onclick="SplitTableManager.addItem()" class="w-full mt-4 p-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-indigo-400 hover:text-indigo-600 transition-all duration-300">
                        <span class="material-icons mr-2">add</span>
                        Adicionar Item
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Split Modal -->
    <div id="create-split-modal" class="modal-modern fixed inset-0 hidden flex items-center justify-center z-50">
        <div class="w-full max-w-md mx-4 bg-white rounded-3xl shadow-lg">
            <div class="p-6">
                <h3 class="font-bold text-2xl mb-6 text-gray-800">Criar Nova Divisão</h3>
                <form id="create-split-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Divisão</label>
                        <input type="text" id="new-split-name" class="form-input rounded-lg" required placeholder="ex: Compras do Fim de Semana" />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                        <textarea id="new-split-description" class="form-input rounded-lg" rows="3" placeholder="Breve descrição da divisão..."></textarea>
                    </div>
                    
                    <div class="flex items-center justify-between pt-4">
                        <button type="button" id="cancel-create-split" class="px-6 py-3 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Cancelar</button>
                        <button type="submit" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-8 rounded-full shadow-md hover:shadow-lg transition-all duration-200">
                            Criar Divisão
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Totals Drawer -->
    <div id="mobile-totals-drawer" class="fixed md:hidden bottom-0 left-0 right-0 bg-white border-t shadow-lg z-40 hidden">
        <div class="p-4">
            <div class="flex justify-between items-center cursor-pointer" onclick="SplitTableManager.toggleMobileTotals()">
                <span class="font-semibold text-gray-700">Total</span>
                <div class="flex items-center">
                    <span id="mobile-grand-total" class="text-lg font-bold text-indigo-600">€0.00</span>
                    <span id="mobile-expand-icon" class="material-icons ml-2 text-gray-400">expand_more</span>
                </div>
            </div>
            <div id="mobile-totals-breakdown" class="mt-4 space-y-2 hidden">
                <!-- Individual participant totals will be generated here -->
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50">
        <!-- Toasts will be added here -->
    </div>

    <script>
        // Initialize PocketBase
        const pb = new PocketBase('https://pb-orderit.povoas.top/');
        
        // Check if user is admin
        const urlParams = new URLSearchParams(window.location.search);
        const isAdmin = urlParams.get('isAdmin') === 'true';
        
        // Global app state
        const AppState = {
            currentUser: '',
            currentSplit: null,
            splits: [],
            isAdmin: isAdmin
        };

        // Utility functions
        const Utils = {
            getInitials: (name) => {
                return name.split(' ').map(word => word.charAt(0)).join('').toUpperCase().substring(0, 2);
            },
            
            getRelativeTime: (dateString) => {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (days > 0) return `há ${days} dia${days > 1 ? 's' : ''}`;
                if (hours > 0) return `há ${hours} hora${hours > 1 ? 's' : ''}`;
                if (minutes > 0) return `há ${minutes} minuto${minutes > 1 ? 's' : ''}`;
                return 'Agora mesmo';
            },
            
            showToast: (message, type = 'info') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-50 text-green-800 border-green-200' : 
                              type === 'error' ? 'bg-red-50 text-red-800 border-red-200' : 
                              'bg-blue-50 text-blue-800 border-blue-200';
                
                toast.className = `toast border ${bgColor}`;
                toast.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span>${message}</span>
                        <button class="ml-4 text-gray-400 hover:text-gray-600" onclick="this.parentElement.parentElement.remove()">
                            <span class="material-icons text-sm">close</span>
                        </button>
                    </div>
                `;
                container.appendChild(toast);
                
                setTimeout(() => {
                    if (toast.parentElement) toast.remove();
                }, 5000);
            },
            
            sanitize: (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            
            formatCurrency: (amount) => {
                return new Intl.NumberFormat('de-DE', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 2
                }).format(amount);
            },
            
            parseCurrency: (str) => {
                return parseFloat(str.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
            }
        };

        // User management
        const UserManager = {
            init: () => {
                const userName = localStorage.getItem('orderItAll_userName');
                if (userName) {
                    AppState.currentUser = userName;
                    UserManager.updateUI();
                    ViewManager.showApp();
                } else {
                    ViewManager.showWelcome();
                }
            },
            
            setUser: (name) => {
                const sanitizedName = name.trim();
                if (sanitizedName) {
                    localStorage.setItem('orderItAll_userName', sanitizedName);
                    AppState.currentUser = sanitizedName;
                    UserManager.updateUI();
                    Utils.showToast(`Welcome, ${sanitizedName}!`, 'success');
                    return true;
                }
                return false;
            },
            
            updateUI: () => {
                const initials = Utils.getInitials(AppState.currentUser);
                document.getElementById('user-avatar').textContent = initials;
            }
        };

        // View management
        const ViewManager = {
            showWelcome: () => {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('welcome-screen').classList.remove('hidden');
                document.getElementById('app').classList.add('hidden');
            },
            
            showApp: () => {
                document.getElementById('loading-screen').classList.add('hidden');    
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                ViewManager.showSplitsList();
                SplitManager.loadSplits();
            },
            
            showSplitsList: () => {
                document.getElementById('splits-list-view').classList.remove('hidden');
                document.getElementById('split-detail-view').classList.add('hidden');
                // Hide mobile totals drawer when viewing splits list
                document.getElementById('mobile-totals-drawer').classList.add('hidden');
            },
            
            showSplitDetail: () => {
                document.getElementById('splits-list-view').classList.add('hidden');
                document.getElementById('split-detail-view').classList.remove('hidden');
                // Show mobile totals drawer when viewing split detail
                document.getElementById('mobile-totals-drawer').classList.remove('hidden');
            }
        };

        // Split management
        const SplitManager = {
            loadSplits: async () => {
                try {
                    let filter = '';
                    if (AppState.isAdmin) {
                        // Admin can see all splits
                        filter = '';
                    } else {
                        // Regular users can only see their own splits
                        filter = `created_by = "${AppState.currentUser}"`;
                    }
                    
                    const splits = await pb.collection('splits').getFullList({
                        filter: filter,
                        sort: '-created'
                    });
                    
                    AppState.splits = splits;
                    SplitManager.renderSplits();
                } catch (error) {
                    Utils.showToast('Failed to load splits', 'error');
                    console.error('Error loading splits:', error);
                }
            },
            
            renderSplits: () => {
                const splitsList = document.getElementById('splits-list');
                const noSplits = document.getElementById('no-splits');
                
                if (AppState.splits.length === 0) {
                    splitsList.innerHTML = '';
                    noSplits.classList.remove('hidden');
                    return;
                }
                
                noSplits.classList.add('hidden');
                splitsList.innerHTML = AppState.splits.map(split => {
                    const totalAmount = split.items ? split.items.reduce((sum, item) => sum + item.price, 0) : 0;
                    const participantCount = split.participants ? split.participants.length : 0;
                    
                    return `
                        <div class="modern-card split-card p-6" onclick="SplitManager.openSplit('${split.id}')">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-bold text-gray-800">${Utils.sanitize(split.name)}</h3>
                                ${AppState.isAdmin ? `<span class="text-xs text-gray-500">por ${Utils.sanitize(split.created_by)}</span>` : ''}
                            </div>
                            <p class="text-gray-600 mb-4">${Utils.sanitize(split.description || 'Sem descrição')}</p>
                            <div class="flex justify-between items-end">
                                <div>
                                    <p class="text-sm text-gray-500">${participantCount} participante${participantCount !== 1 ? 's' : ''}</p>
                                    <p class="text-sm text-gray-500">${split.items ? split.items.length : 0} ${split.items && split.items.length === 1 ? 'item' : 'itens'}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-bold text-indigo-600">${Utils.formatCurrency(totalAmount)}</p>
                                    <p class="text-xs text-gray-500">${Utils.getRelativeTime(split.created)}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            createSplit: async (splitData) => {
                try {
                    const split = await pb.collection('splits').create({
                        name: splitData.name,
                        description: splitData.description || '',
                        created_by: AppState.currentUser,
                        participants: ['Pessoa 1', 'Pessoa 2'], // Default participants
                        items: [
                            {
                                name: 'Item de Exemplo',
                                price: 0,
                                participants: ['Pessoa 1', 'Pessoa 2']
                            }
                        ]
                    });
                    
                    Utils.showToast('Divisão criada com sucesso!', 'success');
                    SplitManager.loadSplits();
                    ModalManager.closeModal('create-split-modal');
                    SplitManager.openSplit(split.id);
                } catch (error) {
                    Utils.showToast('Falha ao criar divisão', 'error');
                    console.error('Error creating split:', error);
                }
            },
            
            openSplit: async (splitId) => {
                try {
                    const split = await pb.collection('splits').getOne(splitId);
                    AppState.currentSplit = split;
                    
                    // Update split details
                    document.getElementById('split-name').value = split.name;
                    document.getElementById('split-description').value = split.description || '';
                    
                    ViewManager.showSplitDetail();
                    SplitTableManager.renderTable();
                } catch (error) {
                    Utils.showToast('Falha ao carregar divisão', 'error');
                    console.error('Error loading split:', error);
                }
            },
            
            saveSplit: async () => {
                if (!AppState.currentSplit) return;
                
                try {
                    const name = document.getElementById('split-name').value.trim();
                    const description = document.getElementById('split-description').value.trim();
                    
                    if (!name) {
                        Utils.showToast('Por favor introduza um nome para a divisão', 'error');
                        return;
                    }
                    
                    await pb.collection('splits').update(AppState.currentSplit.id, {
                        name: name,
                        description: description,
                        participants: AppState.currentSplit.participants,
                        items: AppState.currentSplit.items
                    });
                    
                    Utils.showToast('Divisão guardada com sucesso!', 'success');
                    SplitManager.loadSplits();
                } catch (error) {
                    Utils.showToast('Falha ao guardar divisão', 'error');
                    console.error('Error saving split:', error);
                }
            },
            
            deleteSplit: async () => {
                if (!AppState.currentSplit) return;
                
                if (confirm('Tem a certeza que quer eliminar esta divisão? Esta ação não pode ser desfeita.')) {
                    try {
                        await pb.collection('splits').delete(AppState.currentSplit.id);
                        Utils.showToast('Divisão eliminada com sucesso!', 'success');
                        ViewManager.showSplitsList();
                        SplitManager.loadSplits();
                        AppState.currentSplit = null;
                    } catch (error) {
                        Utils.showToast('Falha ao eliminar divisão', 'error');
                        console.error('Error deleting split:', error);
                    }
                }
            }
        };

        // Split table management
        const SplitTableManager = {
            renderTable: () => {
                if (!AppState.currentSplit) return;
                
                const split = AppState.currentSplit;
                const participants = split.participants || [];
                const items = split.items || [];
                
                // Always render desktop version
                SplitTableManager.renderHeader(participants);
                SplitTableManager.renderBody(items, participants);
                SplitTableManager.renderFooter(participants);
                
                // Render mobile version
                SplitTableManager.renderMobileParticipants(participants);
                SplitTableManager.renderMobileCards(items, participants);
                SplitTableManager.renderMobileTotals(participants);
            },
            
            renderHeader: (participants) => {
                const thead = document.getElementById('split-table-head');
                thead.innerHTML = `
                    <tr>
                        <th class="table-header sticky-col-left">Item</th>
                        <th class="table-header table-cell-center">Preço</th>
                        <th class="table-header table-cell-center">Todos</th>
                        ${participants.map((participant, index) => `
                            <th class="table-header table-cell-center participant-header">
                                <input type="text" 
                                       placeholder="Nome da pessoa"
                                       value="${participant === 'Person 1' || participant === 'Person 2' ? '' : Utils.sanitize(participant)}" 
                                       class="editable-input text-center w-full rounded-lg"
                                       onchange="SplitTableManager.updateParticipant(${index}, this.value)"
                                       onblur="SplitTableManager.saveChanges()">
                                <button class="participant-remove"
                                        onclick="SplitTableManager.removeParticipant(${index})"
                                        title="Remover participante">
                                    <span class="material-icons text-xs">close</span>
                                </button>
                            </th>
                        `).join('')}
                        <th class="table-header table-cell-center w-24">
                            <button class="add-button add-button-participant" onclick="SplitTableManager.addParticipant()" title="Adicionar participante">
                                <span class="material-icons mr-2">person_add</span>
                            </button>
                        </th>
                        <th class="table-header table-cell-right">
                            <div class="flex items-center justify-end gap-2">
                                <span>Preço/Pessoa</span>
                                <button class="btn-modern w-9 h-9" title="Ecrã Inteiro" onclick="SplitTableManager.openFullscreen()">
                                    <span class="material-icons text-gray-600">fullscreen</span>
                                </button>
                            </div>
                        </th>
                    </tr>
                `;
            },
            
            renderBody: (items, participants) => {
                const tbody = document.getElementById('split-table-body');
                tbody.innerHTML = items.map((item, itemIndex) => `
                    <tr class="table-row hover:bg-gray-50 transition-all duration-300">
                        <td class="table-cell font-medium sticky-col-left">
                            <input type="text" 
                                   value="${item.name === 'Sample Item' || item.name === 'New Item' ? '' : Utils.sanitize(item.name)}" 
                                   placeholder="Nome do item"
                                   class="editable-input w-full font-medium rounded-lg"
                                   onchange="SplitTableManager.updateItem(${itemIndex}, 'name', this.value)"
                                   onblur="SplitTableManager.saveChanges()">
                        </td>
                        <td class="table-cell table-cell-right">
                            <div class="flex items-center justify-end">
                                <input type="number" 
                                       value="${item.price || ''}" 
                                       placeholder="0.00"
                                       step="0.01"
                                       min="0"
                                       class="editable-input price-input w-24 rounded-lg"
                                       onchange="SplitTableManager.updateItem(${itemIndex}, 'price', parseFloat(this.value) || 0)"
                                       onblur="SplitTableManager.saveChanges()">
                                <span class="ml-2 text-gray-500 font-medium">€</span>
                            </div>
                        </td>
                        <td class="table-cell table-cell-center">
                            <input type="checkbox" class="checkbox-custom rounded"
                                   ${item.participants.length === participants.length && participants.length > 0 ? 'checked' : ''}
                                   onchange="SplitTableManager.toggleAllParticipants(${itemIndex}, this.checked)">
                        </td>
                        ${participants.map(participant => `
                            <td class="table-cell table-cell-center">
                                <input type="checkbox" class="checkbox-custom rounded" 
                                       ${item.participants.includes(participant) ? 'checked' : ''}
                                       onchange="SplitTableManager.toggleParticipant(${itemIndex}, '${participant}', this.checked)">
                            </td>
                        `).join('')}
                        <td class="table-cell table-cell-center">
                            <button class="item-remove" onclick="SplitTableManager.removeItem(${itemIndex})" title="Remover item">
                                <span class="material-icons text-sm">remove</span>
                            </button>
                        </td>
                        <td class="table-cell table-cell-right text-indigo-600 font-semibold">
                            ${SplitTableManager.calculateItemPerPerson(item)}
                        </td>
                    </tr>
                `).join('') + `
                    <tr class="table-row hover:bg-gray-50 transition-all duration-300">
                        <td class="table-cell sticky-col-left">
                            <button class="add-button w-full text-left justify-start" onclick="SplitTableManager.addItem()" title="Adicionar item">
                                <span class="material-icons text-base mr-3">add</span>
                                <span class="font-medium">Adicionar Item</span>
                            </button>
                        </td>
                        <td class="table-cell"></td>
                        <td class="table-cell"></td>
                        ${participants.map(() => '<td class="table-cell"></td>').join('')}
                        <td class="table-cell"></td>
                        <td class="table-cell"></td>
                    </tr>
                `;
            },
            
            renderFooter: (participants) => {
                const tfoot = document.getElementById('split-table-foot');
                const totals = SplitTableManager.calculateTotals(participants);
                
                tfoot.innerHTML = `
                    <tr class="total-row">
                        <td class="table-cell text-sm uppercase tracking-wider text-gray-100 sticky-col-left">Total Cada</td>
                        <td class="table-cell"></td>
                        <td class="table-cell"></td>
                        ${participants.map(participant => `
                            <td class="table-cell table-cell-center text-indigo-600 font-bold bg-gradient-to-r from-indigo-500 to-indigo-800">
                                ${Utils.formatCurrency(totals[participant] || 0)}
                            </td>
                        `).join('')}
                        <td class="table-cell"></td>
                        <td class="table-cell table-cell-right text-indigo-600 font-bold bg-gradient-to-r from-indigo-500 to-indigo-800">
                            ${Utils.formatCurrency(Object.values(totals).reduce((sum, total) => sum + total, 0))}
                        </td>
                    </tr>
                `;
            },
            
            calculateItemPerPerson: (item) => {
                const participantCount = item.participants.length;
                if (participantCount === 0) return Utils.formatCurrency(0);
                return Utils.formatCurrency(item.price / participantCount);
            },
            
            calculateTotals: (participants) => {
                const totals = {};
                participants.forEach(participant => {
                    totals[participant] = 0;
                });
                
                if (AppState.currentSplit && AppState.currentSplit.items) {
                    AppState.currentSplit.items.forEach(item => {
                        const pricePerPerson = item.price / item.participants.length;
                        item.participants.forEach(participant => {
                            if (totals.hasOwnProperty(participant)) {
                                totals[participant] += pricePerPerson;
                            }
                        });
                    });
                }
                
                return totals;
            },
            
            addParticipant: () => {
                if (!AppState.currentSplit) return;
                
                // Add a new participant with placeholder name
                const newParticipantName = '';
                AppState.currentSplit.participants.push(newParticipantName);
                SplitTableManager.renderTable();
                SplitTableManager.saveChanges();
                
                // Focus on the new participant's input field after a short delay
                setTimeout(() => {
                    const newIndex = AppState.currentSplit.participants.length - 1;
                    const newInput = document.querySelector(`th:nth-child(${3 + newIndex}) input`);
                    if (newInput) {
                        newInput.focus();
                        newInput.select();
                    }
                }, 100);
            },
            
            removeParticipant: (index) => {
                if (!AppState.currentSplit) return;
                
                if (AppState.currentSplit.participants.length <= 1) {
                    Utils.showToast('Não é possível remover o último participante', 'error');
                    return;
                }
                
                const participantName = AppState.currentSplit.participants[index];
                if (confirm(`Remover ${participantName} desta divisão?`)) {
                    // Remove participant from split
                    AppState.currentSplit.participants.splice(index, 1);
                    
                    // Remove participant from all items
                    AppState.currentSplit.items.forEach(item => {
                        item.participants = item.participants.filter(p => p !== participantName);
                    });
                    
                    SplitTableManager.renderTable();
                    SplitTableManager.saveChanges();
                }
            },
            
            updateParticipant: (index, newName) => {
                if (!AppState.currentSplit) return;
                
                const trimmedNewName = newName.trim();
                const oldName = AppState.currentSplit.participants[index];
                
                // If name is empty, don't update
                if (!trimmedNewName) {
                    SplitTableManager.renderTable();
                    return;
                }
                
                if (oldName === trimmedNewName) return;
                
                if (AppState.currentSplit.participants.includes(trimmedNewName)) {
                    Utils.showToast('Nome do participante já existe', 'error');
                    SplitTableManager.renderTable();
                    return;
                }
                
                // Update participant name in split
                AppState.currentSplit.participants[index] = trimmedNewName;
                
                // Update participant name in all items
                AppState.currentSplit.items.forEach(item => {
                    const participantIndex = item.participants.indexOf(oldName);
                    if (participantIndex !== -1) {
                        item.participants[participantIndex] = trimmedNewName;
                    }
                });
                
                SplitTableManager.renderTable();
            },
            
            addItem: () => {
                if (!AppState.currentSplit) return;
                
                const newItem = {
                    name: '',
                    price: 0,
                    participants: [...AppState.currentSplit.participants] // Include all participants by default
                };
                
                AppState.currentSplit.items.push(newItem);
                SplitTableManager.renderTable();
                SplitTableManager.saveChanges();
                
                // Focus on the new item's name input field after a short delay
                setTimeout(() => {
                    const newIndex = AppState.currentSplit.items.length - 1;
                    const newInput = document.querySelector(`tbody tr:nth-child(${newIndex + 1}) td:first-child input`);
                    if (newInput) {
                        newInput.focus();
                        newInput.select();
                    }
                }, 100);
            },
            
            removeItem: (index) => {
                if (!AppState.currentSplit) return;
                
                if (confirm('Remover este item da divisão?')) {
                    AppState.currentSplit.items.splice(index, 1);
                    SplitTableManager.renderTable();
                    SplitTableManager.saveChanges();
                }
            },
            
            updateItem: (index, field, value) => {
                if (!AppState.currentSplit) return;
                
                AppState.currentSplit.items[index][field] = value;
                SplitTableManager.renderTable();
            },
            
            toggleParticipant: (itemIndex, participant, checked) => {
                if (!AppState.currentSplit) return;
                
                const item = AppState.currentSplit.items[itemIndex];
                if (checked) {
                    if (!item.participants.includes(participant)) {
                        item.participants.push(participant);
                    }
                } else {
                    item.participants = item.participants.filter(p => p !== participant);
                }
                
                SplitTableManager.renderTable();
                SplitTableManager.saveChanges();
            },

            toggleAllParticipants: (itemIndex, checked) => {
                if (!AppState.currentSplit) return;
                const item = AppState.currentSplit.items[itemIndex];
                const participants = AppState.currentSplit.participants || [];
                item.participants = checked ? [...participants] : [];
                SplitTableManager.renderTable();
                SplitTableManager.saveChanges();
            },
            
            renderMobileParticipants: (participants) => {
                const container = document.getElementById('mobile-participants-list');
                const countElement = document.getElementById('mobile-participants-count');
                
                if (countElement) {
                    countElement.textContent = participants.length;
                }
                
                if (!container) return;
                
                container.innerHTML = participants.map((participant, index) => `
                    <div class="flex items-center bg-gray-50 rounded-full px-3 py-2 text-sm">
                        <input 
                            type="text"
                            value="${participant === 'Person 1' || participant === 'Person 2' ? '' : Utils.sanitize(participant)}"
                            placeholder="Nome da pessoa"
                            class="bg-transparent border-0 focus:outline-none text-gray-900 font-medium w-20 min-w-0"
                            onchange="SplitTableManager.updateParticipant(${index}, this.value)"
                            onblur="SplitTableManager.saveChanges()"
                        />
                        <button 
                            onclick="SplitTableManager.removeParticipant(${index})"
                            class="ml-2 text-red-500 hover:text-red-700 p-1"
                            title="Remover participante"
                        >
                            <span class="material-icons text-xs">close</span>
                        </button>
                    </div>
                `).join('');
            },
            
            toggleMobileParticipants: () => {
                const content = document.getElementById('mobile-participants-content');
                const icon = document.getElementById('mobile-participants-toggle-icon');
                
                if (content && icon) {
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                        icon.textContent = 'expand_less';
                    } else {
                        content.classList.add('hidden');
                        icon.textContent = 'expand_more';
                    }
                }
            },
            
            renderMobileCards: (items, participants) => {
                const container = document.getElementById('mobile-items-container');
                const countElement = document.getElementById('mobile-items-count');
                
                if (countElement) {
                    countElement.textContent = items.length;
                }
                
                if (!container) return;
                
                container.innerHTML = items.map((item, itemIndex) => `
                    <div class="bg-white p-4 rounded-xl shadow transition-all duration-300">
                        <div class="flex justify-between items-center mb-3">
                            <input 
                                type="text"
                                value="${item.name === 'Sample Item' || item.name === 'New Item' ? '' : Utils.sanitize(item.name)}"
                                class="editable-input font-medium text-lg flex-1 mr-3 rounded-lg"
                                placeholder="Nome do item"
                                onchange="SplitTableManager.updateItem(${itemIndex}, 'name', this.value)"
                                onblur="SplitTableManager.saveChanges()"
                            />
                            <button onclick="SplitTableManager.removeItem(${itemIndex})" class="text-red-500 hover:text-red-700 p-2">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <label class="text-sm text-gray-500 mb-1 block">Preço</label>
                            <div class="flex items-center">
                                <input 
                                    type="number"
                                    value="${item.price || ''}"
                                    min="0"
                                    step="0.01"
                                    placeholder="0.00"
                                    class="editable-input price-input flex-1 rounded-lg"
                                    onchange="SplitTableManager.updateItem(${itemIndex}, 'price', parseFloat(this.value) || 0)"
                                    onblur="SplitTableManager.saveChanges()"
                                />
                                <span class="ml-2 text-gray-500 font-medium">€</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-sm text-gray-500 mb-2 block">Participantes</label>
                            <div class="flex flex-wrap gap-2">
                                ${participants.map(participant => `
                                    <label class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded-full text-sm">
                                        <input type="checkbox" class="checkbox-custom rounded" 
                                               ${item.participants.includes(participant) ? 'checked' : ''}
                                               onchange="SplitTableManager.toggleParticipant(${itemIndex}, '${participant}', this.checked)">
                                        <span>${Utils.sanitize(participant) || 'Sem nome'}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-gray-100 text-right">
                            <span class="text-sm text-gray-500">Por pessoa: </span>
                            <span class="font-semibold text-indigo-600">${SplitTableManager.calculateItemPerPerson(item)}</span>
                        </div>
                    </div>
                `).join('');
            },
            
            renderMobileTotals: (participants) => {
                const totals = SplitTableManager.calculateTotals(participants);
                const grandTotal = Object.values(totals).reduce((sum, total) => sum + total, 0);
                
                // Update grand total
                const grandTotalElement = document.getElementById('mobile-grand-total');
                if (grandTotalElement) {
                    grandTotalElement.textContent = Utils.formatCurrency(grandTotal);
                }
                
                // Update breakdown
                const breakdown = document.getElementById('mobile-totals-breakdown');
                if (breakdown) {
                    breakdown.innerHTML = participants.map(participant => `
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">${Utils.sanitize(participant) || 'Sem nome'}</span>
                            <span class="font-medium text-indigo-600">${Utils.formatCurrency(totals[participant] || 0)}</span>
                        </div>
                    `).join('');
                }
            },
            
            toggleMobileTotals: () => {
                const breakdown = document.getElementById('mobile-totals-breakdown');
                const icon = document.getElementById('mobile-expand-icon');
                
                if (breakdown && icon) {
                    if (breakdown.classList.contains('hidden')) {
                        breakdown.classList.remove('hidden');
                        icon.textContent = 'expand_less';
                    } else {
                        breakdown.classList.add('hidden');
                        icon.textContent = 'expand_more';
                    }
                }
            },
            
            saveChanges: () => {
                // Auto-save changes (debounced)
                clearTimeout(SplitTableManager.saveTimeout);
                SplitTableManager.saveTimeout = setTimeout(() => {
                    SplitManager.saveSplit();
                }, 1000);
            },

            openFullscreen: () => {
                const wrapper = document.getElementById('split-table-wrapper');
                const modal = document.getElementById('fullscreen-table-modal');
                const content = document.getElementById('fullscreen-table-content');
                const titleEl = document.getElementById('fullscreen-table-title');
                if (!wrapper || !modal || !content) return;

                // Create placeholder to restore original position
                let placeholder = document.getElementById('split-table-wrapper-placeholder');
                if (!placeholder) {
                    placeholder = document.createElement('div');
                    placeholder.id = 'split-table-wrapper-placeholder';
                }
                if (!placeholder.parentNode) {
                    wrapper.parentNode.insertBefore(placeholder, wrapper);
                }

                // Move wrapper to modal content
                content.appendChild(wrapper);
                // Expand to full height inside modal
                wrapper.classList.remove('max-h-[70vh]');
                wrapper.classList.add('h-full');

                // Show modal
                modal.classList.remove('hidden');

                // Set modal title to current split name
                const splitName = (AppState.currentSplit && AppState.currentSplit.name)
                    || document.getElementById('split-name')?.value
                    || 'Divisão';
                if (titleEl) titleEl.textContent = splitName;
            },

            closeFullscreen: () => {
                const wrapper = document.getElementById('split-table-wrapper');
                const modal = document.getElementById('fullscreen-table-modal');
                const placeholder = document.getElementById('split-table-wrapper-placeholder');
                const titleEl = document.getElementById('fullscreen-table-title');
                if (!wrapper || !modal || !placeholder) return;

                // Move wrapper back to original position
                placeholder.parentNode.insertBefore(wrapper, placeholder);
                // Restore sizing
                wrapper.classList.remove('h-full');
                wrapper.classList.add('max-h-[70vh]');

                // Hide modal and remove placeholder
                modal.classList.add('hidden');
                placeholder.remove();
                if (titleEl) titleEl.textContent = '';
            }
        };

        // Modal management
        const ModalManager = {
            openModal: (modalId) => {
                const modal = document.getElementById(modalId);
                modal.classList.remove('hidden');
            },
            
            closeModal: (modalId) => {
                const modal = document.getElementById(modalId);
                modal.classList.add('hidden');
                
                // Reset forms
                const form = modal.querySelector('form');
                if (form) form.reset();
            }
        };

        // Event listeners
        function initEventListeners() {
            // Welcome screen
            document.getElementById('start-btn').addEventListener('click', () => {
                const nameInput = document.getElementById('user-name-input');
                const name = nameInput.value.trim();
                
                if (UserManager.setUser(name)) {
                    ViewManager.showApp();
                    nameInput.value = '';
                } else {
                    Utils.showToast('Por favor, insira um nome válido', 'error');
                }
            });
            
            // Enter key on name input
            document.getElementById('user-name-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('start-btn').click();
                }
            });
            
            // Create split button
            document.getElementById('create-split-btn').addEventListener('click', () => {
                ModalManager.openModal('create-split-modal');
            });
            
            // Create split form
            document.getElementById('create-split-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('new-split-name').value.trim();
                const description = document.getElementById('new-split-description').value.trim();
                
                if (name) {
                    SplitManager.createSplit({ name, description });
                } else {
                    Utils.showToast('Por favor, insira um nome para a divisão', 'error');
                }
            });
            
            // Cancel create split
            document.getElementById('cancel-create-split').addEventListener('click', () => {
                ModalManager.closeModal('create-split-modal');
            });
            
            // Back to splits
            document.getElementById('back-to-splits').addEventListener('click', () => {
                ViewManager.showSplitsList();
                AppState.currentSplit = null;
            });
            
            // Save split
            document.getElementById('save-split-btn').addEventListener('click', () => {
                SplitManager.saveSplit();
            });
            
            // Delete split
            document.getElementById('delete-split-btn').addEventListener('click', () => {
                SplitManager.deleteSplit();
            });
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal-modern').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        ModalManager.closeModal(modal.id);
                    }
                });
            });
        }

        // Initialize app
        function initApp() {
            // Check if we should load a specific split directly
            const urlParams = new URLSearchParams(window.location.search);
            const directSplitId = urlParams.get('split');

            if (directSplitId && AppState.currentUser) {
                // Load the specific split directly
                setTimeout(() => {
                    SplitManager.openSplit(directSplitId);
                }, 500);
            } else {
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    UserManager.init();
                    initEventListeners();
                    
                    // Make functions globally available
                    window.SplitManager = SplitManager;
                    window.SplitTableManager = SplitTableManager;
                    window.Utils = Utils;
                    
                    console.log('Divisor de Lista de Compras inicializado com sucesso');
                }, 1500);
            }   
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

    <!-- Fullscreen Table Modal -->
    <div id="fullscreen-table-modal" class="modal-modern fixed inset-0 hidden z-[100]">
        <div class="w-full h-full flex flex-col bg-white">
            <div class="flex items-center justify-between p-3 border-b">
                <div class="flex items-center gap-2 text-gray-700">
                    <span class="material-icons">table_view</span>
                    <span id="fullscreen-table-title" class="font-semibold">&nbsp;</span>
                </div>
                <button class="btn-modern w-10 h-10" onclick="SplitTableManager.closeFullscreen()" title="Fechar">
                    <span class="material-icons text-gray-600">close_fullscreen</span>
                </button>
            </div>
            <div id="fullscreen-table-content" class="flex-1 overflow-hidden p-3">
                <!-- Table wrapper will be moved here dynamically -->
            </div>
        </div>
    </div>
</body>
</html>
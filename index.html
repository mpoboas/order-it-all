<!DOCTYPE html>
<html lang="pt-PT" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order It All!</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- Primary Meta Tags -->
    <meta name="title" content="Order It All! - A aplicação #1 de compras de Celorico de Basto e arredores!" />
    <meta name="description" content="Com esta aplicação vais acabar com todas as discussões e lutas sobre quem vai pagar as minis!" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://mirtilos.povoas.top/" />
    <meta property="og:title" content="Order It All! - A aplicação #1 de compras de Celorico de Basto e arredores!" />
    <meta property="og:description" content="Com esta aplicação vais acabar com todas as discussões e lutas sobre quem vai pagar as minis!" />
    <meta property="og:image" content="./gui.jpg" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- PocketBase SDK -->
    <script src="https://unpkg.com/pocketbase@0.21.1/dist/pocketbase.umd.js"></script>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7f8fc;
            min-height: 100dvh;
        }
        
        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
        
        /* Modern gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .gradient-indigo {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }
        
        /* Card styling with modern shadows */
        .modern-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .modern-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }
        
        /* Item cards */
        .item-card {
            background: #f8fafc;
            border-radius: 16px;
            padding: 16px;
            transition: all 0.2s ease;
            border: 1px solid #f1f5f9;
        }
        
        .item-card:hover {
            background: #f1f5f9;
            transform: translateY(-1px);
        }
        
        /* Status indicators */
        .status-pending {
            color: #f59e0b;
            background: #fef3c7;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-completed {
            color: #10b981;
            background: #d1fae5;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Modern buttons */
        .btn-modern {
            background: white;
            border: none;
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary-modern {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-primary-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
        }
        
        .btn-warning-modern {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-danger-modern {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-danger-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        
        /* Loading animation */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 1rem;
            z-index: 1000;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Modal styling */
        .modal-modern {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Form styling */
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Avatar styling */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }
        
        .avatar-large {
            width: 80px;
            height: 80px;
            font-size: 24px;
        }
        
        /* Edit timer styling */
        .edit-timer {
            background: #fef3c7;
            color: #f59e0b;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        
        .edit-timer.warning {
            background: #fee2e2;
            color: #ef4444;
            animation: pulse 1s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Order edit indication */
        .order-editable {
            border-left: 4px solid #f59e0b;
        }
        
        .status-open {
            color: #10b981;
            background: #d1fae5;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="w-16 h-16 border-4 border-white border-t-transparent rounded-full loading-spinner mx-auto"></div>
            <p class="mt-6 text-xl font-light">A carregar Order It All!</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen hidden">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
            <div class="text-center text-white max-w-md w-full">
                <div class="mb-8">
                    <img src="favicon.ico" alt="Order It All! favicon" class="mx-auto w-16 h-16">
                    <h1 class="text-4xl font-bold my-4">Order It All!</h1>
                    <p class="text-xl opacity-90">A aplicação #1 de compras de Celorico de Basto e arredores!</p>
                </div>
                
                <div class="bg-white/20 backdrop-blur-md rounded-3xl p-8">
                    <h2 class="text-2xl font-semibold mb-6">Começar</h2>
                    <div class="space-y-4">
                        <input 
                            type="text" 
                            id="user-name-input" 
                            placeholder="Introduz o teu nome" 
                            class="w-full px-6 py-4 rounded-2xl bg-white/20 border border-white/30 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50"
                        />
                        <button id="start-btn" class="w-full py-4 bg-white text-purple-600 rounded-2xl font-semibold hover:bg-white/90 transition-all duration-300">
                            Começar a pedir! 🚀
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trips Page -->
        <div id="trips-page" class="hidden min-h-screen">
            <!-- Header -->
            <header class="gradient-bg text-white p-6 top-0 z-40">
                <div class="container mx-auto flex items-center justify-between">
                    <div class="flex items-center">
                        <img src="favicon.ico" alt="Order It All! favicon" class="w-10 h-10 mr-3">
                        <div>
                            <h1 class="text-2xl font-bold">Order It All!</h1>
                            <p class="text-sm opacity-90">Tu pedes, nós entregamos!</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <a href="splitter.html" class="btn-modern w-12 h-12 flex items-center justify-center bg-white/20 hover:bg-white/30 border border-white/30">
                            <span class="material-icons text-white">calculate</span>
                        </a>
                        <div class="avatar cursor-pointer hover:bg-white/20 transition-colors duration-200" id="user-avatar" onclick="UserManager.logout()" title="Clique para sair">?</div>
                    </div>
                </div>
            </header>
            <div class="container mx-auto px-4 py-8">
                
                <!-- Content -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Olá, <span class="gradient-text" id="user-greeting"></span></h2>
                    <p class="text-gray-500">Seleciona uma viagem para fazer o teu pedido</p>
                </div>
                
                <div id="trips-list" class="space-y-4">
                    <!-- Trips will be loaded here -->
                </div>
                
                <div id="no-trips" class="text-center py-16 hidden">
                    <div class="text-6xl mb-4">🛒</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Sem viagens disponíveis</h3>
                    <p class="text-gray-600">Volta mais tarde para novas viagens ao supermercado!</p>
                </div>
            </div>
        </div>

        <!-- Trip Detail Page -->
        <div id="trip-detail-page" class="hidden min-h-screen">
            <!-- Header -->
            <header class="gradient-bg text-white p-6 top-0 z-40">
                <div class="container mx-auto flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="material-icons text-3xl mr-3">shopping_cart</span>
                        <div>
                            <h1 class="text-2xl font-bold">Order It All!</h1>
                            <p class="text-sm opacity-90">Tu pedes, nós entregamos!</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <a href="splitter.html" class="btn-modern w-12 h-12 flex items-center justify-center bg-white/20 hover:bg-white/30 border border-white/30">
                            <span class="material-icons text-white">calculate</span>
                        </a>
                        <div class="avatar cursor-pointer hover:bg-white/20 transition-colors duration-200" id="user-avatar" onclick="UserManager.logout()" title="Clique para sair">?</div>
                    </div>
                </div>
            </header>
            <div class="container mx-auto px-4 py-8">

                <!-- Trip Info -->
                <div class="flex items-center mb-8">
                    <button id="back-to-trips" class="btn-modern w-12 h-12 mr-4">
                        <span class="material-icons text-gray-600">chevron_left</span>
                    </button>
                    <div>
                        <h2 id="trip-name" class="text-3xl font-bold text-gray-900">Nome da Viagem</h2>
                        <p id="trip-description" class="text-gray-500">Descrição da viagem</p>
                    </div>
                </div>

                <!-- Trip Statistics -->
                <div id="trip-stats" class="grid grid-cols-3 gap-2 mb-6 hidden">
                    <div class="modern-card p-3">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mb-2">
                                <span class="material-icons text-blue-600 text-sm">shopping_basket</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-1">Produtos</p>
                            <p id="total-items" class="text-xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                    
                    <div class="modern-card p-3">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center mb-2">
                                <span class="material-icons text-yellow-600 text-sm">euro</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-1">Custo Estimado</p>
                            <p id="estimated-cost" class="text-xl font-bold text-gray-800">€0.00</p>
                        </div>
                    </div>
                    
                    <div id="actual-cost-card" class="modern-card p-3 hidden">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mb-2">
                                <span class="material-icons text-green-600 text-sm">check_circle</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-1">Custo Real</p>
                            <p id="actual-cost" class="text-xl font-bold text-gray-800">€0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Os Teus Pedidos</h3>
                    <div class="flex items-center space-x-2">
                        <button id="refresh-orders" class="btn-modern w-12 h-12">
                            <span class="material-icons text-gray-600">refresh</span>
                        </button>
                        <button id="add-order-btn" class="btn-primary-modern flex items-center">
                            <span class="material-icons mr-2">add</span>
                            Pedir
                        </button>
                    </div>
                </div>
                
                <div id="orders-list" class="space-y-4">
                    <!-- Orders will be loaded here -->
                </div>

                <div id="no-orders" class="text-center py-16 hidden">
                    <div class="text-6xl mb-4">📝</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Ainda sem pedidos</h3>
                    <p class="text-gray-600">Faz o teu primeiro pedido nesta viagem!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Form Modal -->
    <div id="order-modal" class="modal-modern fixed inset-0 hidden flex items-center justify-center z-50">
        <div class="w-full max-w-md mx-4 bg-white rounded-3xl shadow-lg max-h-[90vh] flex flex-col">
            <div class="p-6 pb-4">
                <h1 class="text-2xl font-bold text-gray-900" id="order-modal-title">Novo Pedido</h1>
            </div>
            
            <form id="order-form" class="flex flex-col flex-1 min-h-0">
                <input type="hidden" id="edit-order-id" />
                <div class="flex-1 overflow-y-auto px-6">
                    <div id="order-items">
                        <!-- Items will be added here -->
                    </div>
                    
                    <button type="button" id="add-item-btn" class="w-full flex items-center justify-center text-indigo-600 font-medium py-3 border-2 border-dashed border-gray-300 rounded-xl hover:bg-gray-50 mb-6">
                        <span class="material-icons mr-2">add_circle_outline</span>
                        Adicionar Outro Produto
                    </button>
                    <div class="border-t border-gray-200 pt-4 mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">🔍 Pesquisar Produtos</h4>
                        <div class="space-y-4">
                            <div class="flex gap-2">
                                <input 
                                    type="text" 
                                    id="product-search-input" 
                                    placeholder="Pesquisar produtos..." 
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                />
                                <button 
                                    type="button" 
                                    id="search-products-btn" 
                                    class="btn-primary-modern px-4 py-2 flex items-center justify-center"
                                >
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff">
                                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                        <g id="SVGRepo_iconCarrier">
                                            <path d="M15.7955 15.8111L21 21M18 10.5C18 14.6421 14.6421 18 10.5 18C6.35786 18 3 14.6421 3 10.5C3 6.35786 6.35786 3 10.5 3C14.6421 3 18 6.35786 18 10.5Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                        </g>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Search Results -->
                            <div id="search-results" class="hidden">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-medium text-gray-700">Resultados da Pesquisa</h5>
                                    <div id="search-pagination" class="flex gap-1">
                                        <!-- Pagination buttons will be added here -->
                                    </div>
                                </div>
                                <div id="search-results-list" class="space-y-2 max-h-80 overflow-y-auto">
                                    <!-- Results will be added here -->
                                </div>
                            </div>
                            
                            <!-- Loading indicator -->
                            <div id="search-loading" class="hidden text-center py-4">
                                <div class="inline-block w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full loading-spinner"></div>
                                <p class="text-sm text-gray-600 mt-2">A pesquisar produtos...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-200 p-6 pt-4">
                    <div class="flex items-center justify-between">
                        <button type="button" id="cancel-order" class="px-6 py-3 text-gray-700 font-medium rounded-lg hover:bg-gray-100">Cancelar</button>
                        <button type="submit" id="save-order-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-8 rounded-full shadow-md hover:shadow-lg transition-all duration-200">
                            Fazer Pedido
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50">
        <!-- Toasts will be added here -->
    </div>

    <!-- Scripts -->
    <script>
        // Initialize PocketBase with your server URL
        const pb = new PocketBase('https://pb-orderit.povoas.top/');
        
        // Global app state
        const AppState = {
            currentUser: '',
            currentTrip: null,
            currentPage: 'welcome',
            trips: [],
            orders: [],
            items: [],
            editTimers: {}, // Track edit timers for orders
            isEditing: false, // Track if currently editing an order
            editingOrderId: null
        };

        // Utility functions
        const Utils = {
            getInitials: (name) => {
                return name.split(' ').map(word => word.charAt(0)).join('').toUpperCase().substring(0, 2);
            },
            
            getRelativeTime: (dateString) => {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (days > 0) return `há ${days} dia${days > 1 ? 's' : ''}`;
                if (hours > 0) return `há ${hours} hora${hours > 1 ? 's' : ''}`;
                if (minutes > 0) return `há ${minutes} minuto${minutes > 1 ? 's' : ''}`;
                return 'Agora mesmo';
            },
            
            showToast: (message, type = 'info') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-50 text-green-800 border-green-200' : 
                              type === 'error' ? 'bg-red-50 text-red-800 border-red-200' : 
                              'bg-blue-50 text-blue-800 border-blue-200';
                
                toast.className = `toast border ${bgColor}`;
                toast.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span>${message}</span>
                        <button class="ml-4 text-gray-400 hover:text-gray-600" onclick="this.parentElement.parentElement.remove()">
                            <span class="material-icons text-sm">close</span>
                        </button>
                    </div>
                `;
                container.appendChild(toast);
                
                setTimeout(() => {
                    if (toast.parentElement) toast.remove();
                }, 5000);
            },
            
            sanitize: (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            
            getItemImage: (itemName) => {
                const name = itemName.toLowerCase();
                if (name.includes('banana')) return 'https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?w=100&h=100&fit=crop&crop=center';
                if (name.includes('milk')) return 'https://images.unsplash.com/photo-1550583724-b2692b85b150?w=100&h=100&fit=crop&crop=center';
                if (name.includes('avocado')) return 'https://images.unsplash.com/photo-1523049673857-eb18f1d7b578?w=100&h=100&fit=crop&crop=center';
                if (name.includes('apple')) return 'https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?w=100&h=100&fit=crop&crop=center';
                if (name.includes('bread')) return 'https://images.unsplash.com/photo-1509440159596-0249088772ff?w=100&h=100&fit=crop&crop=center';
                if (name.includes('egg')) return 'https://images.unsplash.com/photo-1518569656558-1f25e69d93d7?w=100&h=100&fit=crop&crop=center';
                return '🛒';
            },
            
            // Edit timer utilities
            isOrderEditable: (orderId) => {
                const timer = AppState.editTimers[orderId];
                if (!timer) return false;
                
                // Calculate the end time (5 minutes from creation)
                const endTime = timer.createdAt + (5 * 60 * 1000);
                const now = new Date().getTime();
                
                return now < endTime;
            },
            
            getRemainingEditTime: (orderId) => {
                const timer = AppState.editTimers[orderId];
                if (!timer) return 0;
                
                // Calculate the end time (5 minutes from creation)
                const endTime = timer.createdAt + (5 * 60 * 1000);
                const now = new Date().getTime();
                
                // Find the distance between now and the end time
                const distance = endTime - now;
                
                // If time is up, return 0
                if (distance < 0) return 0;
                
                // Return remaining seconds
                return Math.floor(distance / 1000);
            },
            
            formatTime: (seconds) => {
                if (seconds <= 0) return "00:00";
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            },
            
            startEditTimer: (orderId) => {
                AppState.editTimers[orderId] = {
                    createdAt: new Date().getTime(),
                    orderId: orderId
                };
                // Save to localStorage for persistence
                localStorage.setItem('orderItAll_editTimers', JSON.stringify(AppState.editTimers));
            },
            
            loadEditTimers: () => {
                const stored = localStorage.getItem('orderItAll_editTimers');
                if (stored) {
                    AppState.editTimers = JSON.parse(stored);
                }
            }
        };

        // Timer Manager - Updates edit timers in real-time
        const TimerManager = {
            interval: null,
            
            start: () => {
                // Clear any existing interval
                if (TimerManager.interval) {
                    clearInterval(TimerManager.interval);
                }
                
                // Start new interval that updates every 1 second
                TimerManager.interval = setInterval(() => {
                    TimerManager.updateTimers();
                }, 1000);
            },
            
            stop: () => {
                if (TimerManager.interval) {
                    clearInterval(TimerManager.interval);
                    TimerManager.interval = null;
                }
            },
            
            updateTimers: () => {
                let hasActiveTimers = false;
                
                AppState.orders.forEach(order => {
                    const timerElement = document.querySelector(`[data-order-id="${order.id}"] .edit-timer`);
                    const editButton = document.querySelector(`[data-order-id="${order.id}"] button[onclick*="editOrder"]`);
                    const orderCard = document.querySelector(`[data-order-id="${order.id}"]`);
                    
                    if (Utils.isOrderEditable(order.id)) {
                        hasActiveTimers = true;
                        const remaining = Utils.getRemainingEditTime(order.id);
                        
                        if (timerElement) {
                            timerElement.textContent = `⏱️ ${Utils.formatTime(remaining)}`;
                            // Add warning class when under 60 seconds
                            if (remaining < 60) {
                                timerElement.classList.add('warning');
                            } else {
                                timerElement.classList.remove('warning');
                            }
                        }
                        
                        // Ensure edit and delete buttons are visible
                        if (editButton) {
                            editButton.style.display = 'flex';
                        }
                        
                        const deleteButton = document.querySelector(`[data-order-id="${order.id}"] button[onclick*="deleteOrder"]`);
                        if (deleteButton) {
                            deleteButton.style.display = 'flex';
                        }
                        
                        // Ensure order has editable styling
                        if (orderCard) {
                            orderCard.classList.add('order-editable');
                            orderCard.classList.remove('order-expired');
                        }
                        
                    } else {
                        // Timer expired
                        if (timerElement) {
                            timerElement.textContent = 'EXPIRADO';
                            timerElement.classList.add('warning');
                            // Remove timer after a short delay
                            setTimeout(() => {
                                if (timerElement && timerElement.parentElement) {
                                    timerElement.remove();
                                }
                            }, 2000);
                        }
                        
                        // Hide edit and delete buttons
                        if (editButton) {
                            editButton.style.display = 'none';
                        }
                        
                        const deleteButton = document.querySelector(`[data-order-id="${order.id}"] button[onclick*="deleteOrder"]`);
                        if (deleteButton) {
                            deleteButton.style.display = 'none';
                        }
                        
                        // Update order styling
                        if (orderCard) {
                            orderCard.classList.remove('order-editable');
                            orderCard.classList.add('order-expired');
                        }
                        
                        // Clean up expired timer from storage
                        if (AppState.editTimers[order.id]) {
                            delete AppState.editTimers[order.id];
                            localStorage.setItem('orderItAll_editTimers', JSON.stringify(AppState.editTimers));
                        }
                    }
                });
                
                // If no active timers, stop the interval to save resources
                if (!hasActiveTimers) {
                    TimerManager.stop();
                }
            }
        };

        // User management
        const UserManager = {
            init: () => {
                const userName = localStorage.getItem('orderItAll_userName');
                if (userName) {
                    AppState.currentUser = userName;
                    UserManager.updateUI();
                    PageManager.show('trips');
                    TripManager.loadTrips();
                }
                // Load edit timers
                Utils.loadEditTimers();
            },
            
            setUser: (name) => {
                const sanitizedName = name.trim();
                if (sanitizedName) {
                    localStorage.setItem('orderItAll_userName', sanitizedName);
                    AppState.currentUser = sanitizedName;
                    UserManager.updateUI();
                    Utils.showToast(`Bem-vindo, ${sanitizedName}!`, 'success');
                    return true;
                }
                return false;
            },
            
            updateUI: () => {
                const initials = Utils.getInitials(AppState.currentUser);
                const avatars = document.querySelectorAll('[id$="avatar"]');
                avatars.forEach(avatar => {
                    avatar.textContent = initials;
                });
            },
            
            logout: () => {
                if (confirm('Tem a certeza que quer sair?')) {
                    localStorage.removeItem('orderItAll_userName');
                    AppState.currentUser = '';
                    AppState.currentTrip = null;
                    AppState.trips = [];
                    AppState.orders = [];
                    AppState.items = [];
                    AppState.editTimers = {};
                    AppState.isEditing = false;
                    AppState.editingOrderId = null;
                    
                    // Stop any running timers
                    TimerManager.stop();
                    
                    // Show welcome screen
                    PageManager.show('welcome');
                    
                    Utils.showToast('Sessão terminada com sucesso', 'success');
                }
            }
        };

        // Page management
        const PageManager = {
            show: (pageName) => {
                document.querySelectorAll('[id$="-page"], #welcome-screen').forEach(page => {
                    page.classList.add('hidden');
                });
                
                const pageElement = document.getElementById(`${pageName}-page`) || document.getElementById('welcome-screen');
                if (pageElement) {
                    pageElement.classList.remove('hidden');
                    AppState.currentPage = pageName;
                }
            }
        };

        // Product Search Manager
        const ProductSearchManager = {
            currentResults: [],
            currentPage: 0,
            resultsPerPage: 10,
            
            search: async (query) => {
                if (!query.trim()) {
                    Utils.showToast('Por favor introduz um termo de pesquisa', 'error');
                    return;
                }
                
                ProductSearchManager.showLoading(true);
                ProductSearchManager.hideResults();
                
                try {
                    const response = await fetch(`https://supersave.pt/web/api/newLastStateCall.php?search=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    if (data.products && data.products.length > 0) {
                        ProductSearchManager.currentResults = data.products;
                        ProductSearchManager.currentPage = 0;
                        ProductSearchManager.renderResults();
                        ProductSearchManager.showResults();
                    } else {
                        ProductSearchManager.showNoResults();
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    Utils.showToast('Falha ao pesquisar produtos', 'error');
                } finally {
                    ProductSearchManager.showLoading(false);
                }
            },
            
            renderResults: () => {
                const startIndex = ProductSearchManager.currentPage * ProductSearchManager.resultsPerPage;
                const endIndex = startIndex + ProductSearchManager.resultsPerPage;
                const pageResults = ProductSearchManager.currentResults.slice(startIndex, endIndex);
                
                const resultsContainer = document.getElementById('search-results-list');
                resultsContainer.innerHTML = pageResults.map(product => {
                    const bestPrice = ProductSearchManager.getBestPrice(product);
                    
                    return `
                        <div class="bg-gray-50 rounded-lg p-3 border">
                            <div class="flex items-center gap-3">
                                <img 
                                    src="${product.imageURL}" 
                                    alt="${Utils.sanitize(product.name)}"
                                    class="w-16 h-16 object-cover rounded-lg bg-white"
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                />
                                <div class="w-16 h-16 bg-gray-200 rounded-lg items-center justify-center text-2xl hidden">
                                    🛒
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h6 class="font-medium text-gray-800 text-sm truncate">${Utils.sanitize(product.name)}</h6>
                                    <p class="text-xs text-gray-600">${Utils.sanitize(product.marca)}</p>
                                    ${product.capacity ? `<p class="text-xs text-gray-500">${Utils.sanitize(product.capacity)}</p>` : ''}
                                    <p class="text-sm font-semibold text-green-600 mt-1">${bestPrice}</p>
                                </div>
                                <button 
                                    type="button" 
                                    class="btn-primary-modern px-3 py-1 text-2xl flex items-center justify-center"
                                    onclick="ProductSearchManager.addToOrder('${product.id}')"
                                    aria-label="Adicionar ao Pedido"
                                >
                                    +
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                ProductSearchManager.renderPagination();
            },
            
            getBestPrice: (product) => {
                const prices = [];
                
                // Check campaign prices first (discounted)
                if (product.priceCampaignContinente) prices.push({ price: parseFloat(product.priceCampaignContinente), store: 'Continente' });
                if (product.priceCampaignPingoDoce) prices.push({ price: parseFloat(product.priceCampaignPingoDoce), store: 'Pingo Doce' });
                if (product.priceCampaignAuchan) prices.push({ price: parseFloat(product.priceCampaignAuchan), store: 'Auchan' });
                
                // If no campaign prices, check regular prices
                if (prices.length === 0) {
                    if (product.pricePerUnitContinente) prices.push({ price: parseFloat(product.pricePerUnitContinente), store: 'Continente' });
                    if (product.pricePerUnitPingoDoce) prices.push({ price: parseFloat(product.pricePerUnitPingoDoce), store: 'Pingo Doce' });
                    if (product.pricePerUnitAuchan) prices.push({ price: parseFloat(product.pricePerUnitAuchan), store: 'Auchan' });
                }
                
                if (prices.length === 0) return 'Preço não disponível';
                
                const bestPrice = prices.reduce((min, current) => current.price < min.price ? current : min);
                return `€${bestPrice.price.toFixed(2)} no ${bestPrice.store}`;
            },
            
            renderPagination: () => {
                const totalPages = Math.ceil(ProductSearchManager.currentResults.length / ProductSearchManager.resultsPerPage);
                const paginationContainer = document.getElementById('search-pagination');
                
                if (totalPages <= 1) {
                    paginationContainer.innerHTML = '';
                    return;
                }
                
                let paginationHTML = '';
                
                // Previous button
                if (ProductSearchManager.currentPage > 0) {
                    paginationHTML += `<button type="button" class="px-2 py-1 text-xs bg-gray-200 rounded" onclick="ProductSearchManager.goToPage(${ProductSearchManager.currentPage - 1})">←</button>`;
                }
                
                // Page numbers
                for (let i = 0; i < totalPages; i++) {
                    const isActive = i === ProductSearchManager.currentPage;
                    paginationHTML += `<button type="button" class="px-2 py-1 text-xs rounded ${isActive ? 'bg-indigo-600 text-white' : 'bg-gray-200'}" onclick="ProductSearchManager.goToPage(${i})">${i + 1}</button>`;
                }
                
                // Next button
                if (ProductSearchManager.currentPage < totalPages - 1) {
                    paginationHTML += `<button type="button" class="px-2 py-1 text-xs bg-gray-200 rounded" onclick="ProductSearchManager.goToPage(${ProductSearchManager.currentPage + 1})">→</button>`;
                }
                
                paginationContainer.innerHTML = paginationHTML;
            },
            
            goToPage: (page) => {
                ProductSearchManager.currentPage = page;
                ProductSearchManager.renderResults();
            },
            
            addToOrder: (productId) => {
                const product = ProductSearchManager.currentResults.find(p => p.id == productId);
                if (!product) return;
                
                // Get the best price for unit_price
                const bestPriceInfo = ProductSearchManager.getBestPriceInfo(product);
                
                // Add item to the order form
                OrderFormManager.addItem({
                    name: product.name,
                    quantity: 1,
                    brand: product.marca || '',
                    notes: `De ${product.marca}${product.capacity ? ` - ${product.capacity}` : ''}`,
                    unit_price: bestPriceInfo.price || 0,
                    image_url: product.imageURL || ''
                });
                
                Utils.showToast(`"${product.name}" adicionado ao pedido`, 'success');
                
                // Scroll to the new item
                setTimeout(() => {
                    const itemForms = document.querySelectorAll('.item-form');
                    const lastItem = itemForms[itemForms.length - 1];
                    if (lastItem) {
                        lastItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 100);
            },

            getBestPriceInfo: (product) => {
                const prices = [];
                
                // Check campaign prices first (discounted)
                if (product.priceCampaignContinente) prices.push({ price: parseFloat(product.priceCampaignContinente), store: 'Continente' });
                if (product.priceCampaignPingoDoce) prices.push({ price: parseFloat(product.priceCampaignPingoDoce), store: 'Pingo Doce' });
                if (product.priceCampaignAuchan) prices.push({ price: parseFloat(product.priceCampaignAuchan), store: 'Auchan' });
                
                // If no campaign prices, check regular prices
                if (prices.length === 0) {
                    if (product.pricePerUnitContinente) prices.push({ price: parseFloat(product.pricePerUnitContinente), store: 'Continente' });
                    if (product.pricePerUnitPingoDoce) prices.push({ price: parseFloat(product.pricePerUnitPingoDoce), store: 'Pingo Doce' });
                    if (product.pricePerUnitAuchan) prices.push({ price: parseFloat(product.pricePerUnitAuchan), store: 'Auchan' });
                }
                
                if (prices.length === 0) return { price: 0, store: '', formatted: 'Preço não disponível' };
                
                const bestPrice = prices.reduce((min, current) => current.price < min.price ? current : min);
                return {
                    price: bestPrice.price,
                    store: bestPrice.store,
                    formatted: `€${bestPrice.price.toFixed(2)} no ${bestPrice.store}`
                };
            },
            
            showLoading: (show) => {
                const loadingElement = document.getElementById('search-loading');
                if (show) {
                    loadingElement.classList.remove('hidden');
                } else {
                    loadingElement.classList.add('hidden');
                }
            },
            
            showResults: () => {
                document.getElementById('search-results').classList.remove('hidden');
            },
            
            hideResults: () => {
                document.getElementById('search-results').classList.add('hidden');
            },
            
            showNoResults: () => {
                const resultsContainer = document.getElementById('search-results-list');
                resultsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">🔍</div>
                        <p class="text-gray-600">Nenhum produto encontrado</p>
                    </div>
                `;
                ProductSearchManager.showResults();
            },
            
            initEvents: () => {
                // Search button
                document.getElementById('search-products-btn').addEventListener('click', () => {
                    const query = document.getElementById('product-search-input').value;
                    ProductSearchManager.search(query);
                });
                
                // Enter key on search input
                document.getElementById('product-search-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const query = e.target.value;
                        ProductSearchManager.search(query);
                    }
                });
            }
        };
        
        // Trip management
        const TripManager = {
            loadTrips: async () => {
                try {
                    const trips = await pb.collection('trips').getFullList({
                        sort: '-created'
                    });
                    AppState.trips = trips;
                    TripManager.renderTrips();
                    TripManager.updateUserGreeting();
                } catch (error) {
                    Utils.showToast('Falha ao carregar viagens', 'error');
                    console.error('Error loading trips:', error);
                }
            },
            
            renderTrips: () => {
                const tripsList = document.getElementById('trips-list');
                const noTrips = document.getElementById('no-trips');
                
                if (AppState.trips.length === 0) {
                    tripsList.innerHTML = '';
                    noTrips.classList.remove('hidden');
                    return;
                }
                
                noTrips.classList.add('hidden');
                tripsList.innerHTML = AppState.trips.map(trip => `
                    <div class="modern-card cursor-pointer p-6" onclick="TripManager.openTrip('${trip.id}')">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800">${Utils.sanitize(trip.name)}</h2>
                            <div class="${trip.status === 'open' ? 'status-open' : 'bg-red-100 text-red-600 px-3 py-1 rounded-full text-sm font-medium'}">
                                <span class="material-icons text-sm mr-1">${trip.status === 'open' ? 'hourglass_top' : 'close'}</span>
                                ${trip.status === 'open' ? 'A Decorrer' : 'Terminada'}
                            </div>
                        </div>
                        <p class="text-gray-600 mb-4">${Utils.sanitize(trip.description || 'Sem descrição')}</p>
                        <p class="text-sm text-gray-500">${new Intl.DateTimeFormat('pt-PT', { year: 'numeric', month: 'long', day: 'numeric' }).format(new Date(trip.created))} • ${new Intl.DateTimeFormat('pt-PT', { hour: '2-digit', minute: '2-digit' }).format(new Date(trip.created))}</p>
                    </div>
                `).join('');
            },
            
            openTrip: async (tripId) => {
                try {
                    const trip = await pb.collection('trips').getOne(tripId);
                    AppState.currentTrip = trip;
                    
                    document.getElementById('trip-name').textContent = trip.name;
                    document.getElementById('trip-description').textContent = trip.description || 'Sem descrição';
                    
                    const addOrderBtn = document.getElementById('add-order-btn');
                    if (trip.status === 'closed') {
                        addOrderBtn.style.display = 'none';
                    } else {
                        addOrderBtn.style.display = 'flex';
                    }
                    
                    PageManager.show('trip-detail');
                    OrderManager.loadOrders(tripId);
                    TimerManager.start(); // Start timer updates
                } catch (error) {
                    Utils.showToast('Falha ao carregar detalhes da viagem', 'error');
                    console.error('Error loading trip:', error);
                }
            },
            
            updateUserGreeting: () => {
                const userGreetingElement = document.getElementById('user-greeting');
                if (userGreetingElement && AppState.currentUser) {
                    userGreetingElement.textContent = AppState.currentUser;
                }
            }
        };

        // Order management
        const OrderManager = {
            loadOrders: async (tripId) => {
                try {
                    // Get all items for this trip and current user
                    const items = await pb.collection('items').getFullList({
                        expand: 'order_id',
                        filter: `order_id.trip_id = "${tripId}" && order_id.user_name = "${AppState.currentUser}"`,
                        sort: 'created'
                    });
            
                    // Group items by order_id
                    const ordersMap = {};
                    for (const item of items) {
                        const order = item.expand.order_id;
                        if (!ordersMap[order.id]) {
                            ordersMap[order.id] = {
                                ...order,
                                items: []
                            };
                        }
                        ordersMap[order.id].items.push(item);
                    }
            
                    const orders = Object.values(ordersMap);
            
                    // Save and handle edit timers
                    AppState.orders = orders;
                    for (const order of orders) {
                        if (!AppState.editTimers[order.id]) {
                            const orderCreated = new Date(order.created).getTime();
                            const now = new Date().getTime();
                            const fiveMinutes = 5 * 60 * 1000;
            
                            if ((now - orderCreated) < fiveMinutes) {
                                AppState.editTimers[order.id] = {
                                    createdAt: orderCreated,
                                    orderId: order.id
                                };
                                localStorage.setItem('orderItAll_editTimers', JSON.stringify(AppState.editTimers));
                            }
                        }
                    }
            
                    OrderManager.renderOrders();
                } catch (error) {
                    Utils.showToast('Falha ao carregar pedidos', 'error');
                    console.error('Error loading orders:', error);
                }
            },
            
            updateTripStats: () => {
                const statsContainer = document.getElementById('trip-stats');
                const totalItemsElement = document.getElementById('total-items');
                const estimatedCostElement = document.getElementById('estimated-cost');
                const actualCostElement = document.getElementById('actual-cost');
                const actualCostCard = document.getElementById('actual-cost-card');
                
                let totalItems = 0;
                let estimatedCost = 0;
                let actualCost = 0;
                let hasFoundItems = false;
                
                // Calculate stats from all orders
                AppState.orders.forEach(order => {
                    if (order.items) {
                        order.items.forEach(item => {
                            totalItems += 1;
                            
                            // Add to estimated cost (use unit_price * quantity or fallback to price)
                            const itemCost = (item.unit_price || 0) * (item.quantity || 1) || item.price || 0;
                            estimatedCost += itemCost;
                            
                            // Add to actual cost only if item is found
                            if (item.found_status === 'found') {
                                actualCost += item.price || itemCost;
                                hasFoundItems = true;
                            }
                        });
                    }
                });
                
                // Update the display
                if (totalItems > 0) {
                    statsContainer.classList.remove('hidden');
                    totalItemsElement.textContent = totalItems;
                    estimatedCostElement.textContent = `€${estimatedCost.toFixed(2)}`;
                    
                    // Show actual cost only if there are found items
                    if (hasFoundItems) {
                        actualCostCard.classList.remove('hidden');
                        actualCostElement.textContent = `€${actualCost.toFixed(2)}`;
                    } else {
                        actualCostCard.classList.add('hidden');
                    }
                } else {
                    statsContainer.classList.add('hidden');
                }
            },
            
            renderOrders: () => {
                const ordersList = document.getElementById('orders-list');
                const noOrders = document.getElementById('no-orders');
            
                if (AppState.orders.length === 0) {
                    ordersList.innerHTML = '';
                    noOrders.classList.remove('hidden');
                    // Hide stats when no orders
                    document.getElementById('trip-stats').classList.add('hidden');
                    return;
                }
            
                noOrders.classList.add('hidden');
                ordersList.innerHTML = AppState.orders.map((order, index) => {
                    const isEditable = Utils.isOrderEditable(order.id);
                    const remainingTime = Utils.getRemainingEditTime(order.id);
                    const orderClass = isEditable ? 'order-editable' : 'order-expired';
                    
                    return `
                        <div class="bg-white rounded-2xl shadow-lg p-4 ${orderClass}" data-order-id="${order.id}">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    <h4 class="text-lg font-semibold text-gray-800">Pedido ${index + 1}</h4>
                                    <p class="text-xs text-gray-500 ml-3">${Utils.getRelativeTime(order.created)}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${isEditable ? `
                                        <button class="btn-warning-modern flex items-center" onclick="OrderManager.editOrder('${order.id}')">
                                            <span class="material-icons text-sm mr-1">edit</span>
                                            Editar
                                        </button>
                                        <button class="btn-danger-modern flex items-center" onclick="OrderManager.deleteOrder('${order.id}')">
                                            <span class="material-icons text-sm mr-1">delete</span>
                                            Eliminar
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${(order.items || []).map(item => `
                                    <div class="bg-gray-100 rounded-xl overflow-hidden">
                                        <div class="p-3">
                                            <div class="flex items-start">
                                                <img alt="${Utils.sanitize(item.name)}" 
                                                    class="w-12 h-12 rounded-lg object-cover mr-3" 
                                                    src="${item.image_url || Utils.getItemImage(item.name)}"
                                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                <div class="w-12 h-12 rounded-lg bg-gray-200 mr-3 items-center justify-center text-2xl hidden">
                                                    🛒
                                                </div>
                                                <div class="flex-grow">
                                                    <div class="flex justify-between items-start">
                                                        <div>
                                                            <p class="font-semibold text-gray-800">${Utils.sanitize(item.name)}</p>
                                                            <div class="flex items-center text-sm text-gray-500 mt-1">
                                                                <div class="flex items-center mr-3">
                                                                    <span class="material-icons text-base mr-1">shopping_basket</span>
                                                                    <span>${item.quantity}</span>
                                                                </div>
                                                                ${item.brand ? `
                                                                    <div class="flex items-center">
                                                                        <span class="material-icons text-base mr-1">label</span>
                                                                        <span>${item.brand === 'Official' ? 'Original' : item.brand === 'Off-brand' ? 'Branca' : Utils.sanitize(item.brand)}</span>
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                        <p class="font-semibold text-gray-800">
                                                            ${item.price > 0 ? `€${item.price.toFixed(2)}` : ''}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        ${item.notes ? `
                                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 text-sm text-yellow-800">
                                            <span class="font-medium">Notas:</span> ${Utils.sanitize(item.notes)}
                                        </div>
                                    ` : ''}
                                        <div class="${
                                            item.found_status === 'found' ? 'bg-green-500' :
                                            item.found_status === 'not_available' ? 'bg-red-500' :
                                            'bg-yellow-500'
                                        } text-white text-xs font-medium py-1 px-3 flex items-center justify-center">
                                            <span class="material-icons text-xs mr-1">${
                                                item.found_status === 'found' ? 'check_circle' :
                                                item.found_status === 'not_available' ? 'cancel' :
                                                'hourglass_top'
                                            }</span>
                                            <span>${
                                                item.found_status === 'found' ? 'Comprado' :
                                                item.found_status === 'not_available' ? 'Não havia' :
                                                'Por comprar'
                                            }</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Update trip statistics
                OrderManager.updateTripStats();
            },
            
            editOrder: async (orderId) => {
                try {
                    // Check if order is still editable
                    if (!Utils.isOrderEditable(orderId)) {
                        Utils.showToast('O pedido já não pode ser editado (limite de 5 minutos excedido)', 'error');
                        return;
                    }
                    
                    const order = AppState.orders.find(o => o.id === orderId);
                    if (!order) {
                        Utils.showToast('Pedido não encontrado', 'error');
                        return;
                    }
                    
                    // Set editing state
                    AppState.isEditing = true;
                    AppState.editingOrderId = orderId;
                    
                    // Update modal title
                    document.getElementById('order-modal-title').textContent = 'Editar Pedido';
                    document.getElementById('save-order-btn').textContent = 'Atualizar Pedido';
                    document.getElementById('edit-order-id').value = orderId;
                    
                    // Clear existing items
                    const itemsContainer = document.getElementById('order-items');
                    itemsContainer.innerHTML = '';
                    
                    // Populate with existing items
                    order.items.forEach(item => {
                        OrderFormManager.addItem(item);
                    });
                    
                    // If no items, add one empty item
                    if (order.items.length === 0) {
                        OrderFormManager.addItem();
                    }
                    
                    // Show modal
                    document.getElementById('order-modal').classList.remove('hidden');
                    
                } catch (error) {
                    Utils.showToast('Falha ao editar pedido', 'error');
                    console.error('Error editing order:', error);
                }
            },           
            
            createOrder: async (orderData) => {
                try {
                    const order = await pb.collection('orders').create({
                        trip_id: AppState.currentTrip.id,
                        user_name: orderData.user_name,
                        can_edit_until: new Date(Date.now() + 5 * 60 * 1000).toISOString()
                    });
                    
                    // Start edit timer
                    Utils.startEditTimer(order.id);
                    
                    for (const item of orderData.items) {
                        await pb.collection('items').create({
                            order_id: order.id,
                            name: item.name,
                            quantity: parseFloat(item.quantity),
                            unit_price: parseFloat(item.unit_price) || 0,
                            brand: item.brand || '',
                            notes: item.notes || '',
                            image_url: item.image_url || '',
                            found_status: 'pending',
                            price: parseFloat(item.quantity) * parseFloat(item.unit_price || 0)
                        });
                    }
                    
                    Utils.showToast('Pedido criado com sucesso!', 'success');
                    OrderManager.loadOrders(AppState.currentTrip.id);
                    OrderFormManager.closeModal();
                    
                } catch (error) {
                    Utils.showToast('Falha ao criar pedido', 'error');
                    console.error('Error creating order:', error);
                }
            },
            
            updateOrder: async (orderId, orderData) => {
                try {
                    // Check if order is still editable
                    if (!Utils.isOrderEditable(orderId)) {
                        Utils.showToast('O pedido já não pode ser editado (limite de 5 minutos excedido)', 'error');
                        return;
                    }
                    
                    // Delete existing items
                    const existingItems = await pb.collection('items').getFullList({
                        filter: `order_id = "${orderId}"`
                    });
                    
                    for (const item of existingItems) {
                        await pb.collection('items').delete(item.id);
                    }
                    
                    // Create new items
                    for (const item of orderData.items) {
                        await pb.collection('items').create({
                            order_id: orderId,
                            name: item.name,
                            quantity: parseFloat(item.quantity),
                            unit_price: parseFloat(item.unit_price) || 0,
                            brand: item.brand || '',
                            notes: item.notes || '',
                            image_url: item.image_url || '',
                            found_status: 'pending',
                            price: parseFloat(item.quantity) * parseFloat(item.unit_price || 0)
                        });
                    }
                    
                    Utils.showToast('Pedido atualizado com sucesso!', 'success');
                    OrderManager.loadOrders(AppState.currentTrip.id);
                    OrderFormManager.closeModal();
                    
                } catch (error) {
                    Utils.showToast('Falha ao atualizar pedido', 'error');
                    console.error('Error updating order:', error);
                }
            },

            deleteOrder: async (orderId) => {
                try {
                    // Check if order is still editable
                    if (!Utils.isOrderEditable(orderId)) {
                        Utils.showToast('O pedido já não pode ser eliminado (limite de 5 minutos excedido)', 'error');
                        return;
                    }
                    
                    // Confirm deletion
                    if (!confirm('Tens a certeza que queres eliminar este pedido? Esta ação não pode ser desfeita.')) {
                        return;
                    }
                    
                    const order = AppState.orders.find(o => o.id === orderId);
                    if (!order) {
                        Utils.showToast('Pedido não encontrado', 'error');
                        return;
                    }
                    
                    // Delete all items first
                    const items = await pb.collection('items').getFullList({
                        filter: `order_id = "${orderId}"`
                    });
                    
                    for (const item of items) {
                        await pb.collection('items').delete(item.id);
                    }
                    
                    // Delete the order
                    await pb.collection('orders').delete(orderId);
                    
                    // Clean up timer
                    if (AppState.editTimers[orderId]) {
                        delete AppState.editTimers[orderId];
                        localStorage.setItem('orderItAll_editTimers', JSON.stringify(AppState.editTimers));
                    }
                    
                    Utils.showToast('Pedido eliminado com sucesso!', 'success');
                    OrderManager.loadOrders(AppState.currentTrip.id);
                    
                } catch (error) {
                    Utils.showToast('Falha ao eliminar pedido', 'error');
                    console.error('Error deleting order:', error);
                }
            }
        };

        // Order form management
        const OrderFormManager = {
            openModal: () => {
                // Reset editing state
                AppState.isEditing = false;
                AppState.editingOrderId = null;
                
                // Update modal title
                document.getElementById('order-modal-title').textContent = 'Novo Pedido';
                document.getElementById('save-order-btn').textContent = 'Guardar Pedido';
                document.getElementById('edit-order-id').value = '';
                
                const modal = document.getElementById('order-modal');
                OrderFormManager.resetForm();
                OrderFormManager.resetSearch();
                OrderFormManager.addItem();
                modal.classList.remove('hidden');
            },
            
            closeModal: () => {
                const modal = document.getElementById('order-modal');
                modal.classList.add('hidden');
                
                // Reset editing state
                AppState.isEditing = false;
                AppState.editingOrderId = null;
                
                // Reset form and search
                OrderFormManager.resetForm();
                OrderFormManager.resetSearch();
            },
            
            resetForm: () => {
                const orderItems = document.getElementById('order-items');
                if (orderItems) {
                    orderItems.innerHTML = '';
                }
            },

            resetSearch: () => {
                // Clear search input
                const searchInput = document.getElementById('product-search-input');
                if (searchInput) {
                    searchInput.value = '';
                }
                
                // Hide search results
                const searchResults = document.getElementById('search-results');
                if (searchResults) {
                    searchResults.classList.add('hidden');
                }
                
                // Hide loading indicator
                const searchLoading = document.getElementById('search-loading');
                if (searchLoading) {
                    searchLoading.classList.add('hidden');
                }
                
                // Clear results list
                const searchResultsList = document.getElementById('search-results-list');
                if (searchResultsList) {
                    searchResultsList.innerHTML = '';
                }
                
                // Clear pagination
                const searchPagination = document.getElementById('search-pagination');
                if (searchPagination) {
                    searchPagination.innerHTML = '';
                }
                
                // Reset ProductSearchManager state
                if (window.ProductSearchManager) {
                    ProductSearchManager.currentResults = [];
                    ProductSearchManager.currentPage = 0;
                }
            },
            
            addItem: (existingItem = null) => {
                const itemsContainer = document.getElementById('order-items');
                const timestamp = Date.now();
            
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-form mb-4 p-4 border border-gray-200 rounded-xl';
                itemDiv.innerHTML = `
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Produto</label>
                            <input class="item-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" 
                                   type="text" placeholder="ex. Bananas" value="${existingItem ? Utils.sanitize(existingItem.name) : ''}" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Quantidade</label>
                            <input class="item-quantity w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" 
                                   type="number" min="1" value="${existingItem ? existingItem.quantity : 1}" required />
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Preço p/Uni. (€)</label>
                            <input class="item-unit-price w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" 
                                   type="number" min="0" step="0.01" placeholder="0.00" value="${existingItem ? (existingItem.unit_price || '') : ''}" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Preço Total</label>
                            <input class="item-total-price w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" 
                                   type="text" readonly placeholder="Calculado automaticamente" />
                        </div>
                    </div>
                    <div class="mb-4">
                        <span class="block text-sm font-medium text-gray-700 mb-2">Marca (opcional)</span>
                        <div class="flex items-center space-x-6">
                            <div class="flex items-center">
                                <input class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" 
                                       name="brand-${timestamp}" type="radio" value="Official" 
                                       ${!existingItem || existingItem.brand === 'Official' ? 'checked' : ''} />
                                <label class="ml-2 block text-sm text-gray-900">Original</label>
                            </div>
                            <div class="flex items-center">
                                <input class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" 
                                       name="brand-${timestamp}" type="radio" value="Off-brand" 
                                       ${existingItem && existingItem.brand === 'Off-brand' ? 'checked' : ''} />
                                <label class="ml-2 block text-sm text-gray-900">Branca</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notas (opcional)</label>
                        <textarea class="item-notes w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" 
                                  placeholder="Qualquer requisito específico..." rows="2">${existingItem ? Utils.sanitize(existingItem.notes || '') : ''}</textarea>
                    </div>
                    <input type="hidden" class="item-image-url" value="${existingItem ? (existingItem.image_url || '') : ''}" />
                    <button type="button" class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center" onclick="this.parentElement.remove()">
                        <span class="material-icons text-base mr-1">delete</span>
                        Remover Produto
                    </button>
                `;
                itemsContainer.appendChild(itemDiv);
                
                // Add event listeners for price calculation
                const quantityInput = itemDiv.querySelector('.item-quantity');
                const unitPriceInput = itemDiv.querySelector('.item-unit-price');
                const totalPriceInput = itemDiv.querySelector('.item-total-price');
                
                const calculateTotal = () => {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const unitPrice = parseFloat(unitPriceInput.value) || 0;
                    const total = quantity * unitPrice;
                    totalPriceInput.value = total > 0 ? `€${total.toFixed(2)}` : '';
                };
                
                quantityInput.addEventListener('input', calculateTotal);
                unitPriceInput.addEventListener('input', calculateTotal);
                
                // Calculate initial total
                calculateTotal();
            },
            
            submitOrder: () => {
                const items = [];
                document.querySelectorAll('.item-form').forEach(itemElement => {
                    const name = itemElement.querySelector('.item-name').value.trim();
                    const quantity = itemElement.querySelector('.item-quantity').value;
                    const unitPrice = itemElement.querySelector('.item-unit-price').value;
                    const brandRadio = itemElement.querySelector('input[type="radio"]:checked');
                    const brand = brandRadio ? brandRadio.value : '';
                    const notes = itemElement.querySelector('.item-notes').value.trim();
                    const imageUrl = itemElement.querySelector('.item-image-url').value;
                    
                    if (name && quantity) {
                        items.push({
                            name,
                            quantity: parseInt(quantity),
                            unit_price: parseFloat(unitPrice) || 0,
                            brand,
                            notes,
                            image_url: imageUrl
                        });
                    }
                });
                
                if (items.length === 0) {
                    Utils.showToast('Por favor adiciona pelo menos um produto', 'error');
                    return;
                }
                
                const orderData = {
                    user_name: AppState.currentUser,
                    items
                };
                
                if (AppState.isEditing && AppState.editingOrderId) {
                    OrderManager.updateOrder(AppState.editingOrderId, orderData);
                } else {
                    OrderManager.createOrder(orderData);
                }
            }
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                UserManager.init();
            }, 1500);
            
            // Welcome screen
            document.getElementById('start-btn').addEventListener('click', () => {
                const nameInput = document.getElementById('user-name-input');
                const name = nameInput.value.trim();
                
                if (UserManager.setUser(name)) {
                    PageManager.show('trips');
                    TripManager.loadTrips();
                    nameInput.value = '';
                } else {
                    Utils.showToast('Por favor introduz um nome válido', 'error');
                }
            });
            
            // Enter key on name input
            document.getElementById('user-name-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('start-btn').click();
                }
            });
            
            // Back button
            document.getElementById('back-to-trips').addEventListener('click', () => {
                PageManager.show('trips');
                AppState.currentTrip = null;
                TimerManager.stop(); // Stop timer updates when leaving trip detail page
            });
            
            // Add order button
            document.getElementById('add-order-btn').addEventListener('click', () => {
                OrderFormManager.openModal();
            });
            
            // Refresh orders button
            document.getElementById('refresh-orders').addEventListener('click', () => {
                if (AppState.currentTrip) {
                    OrderManager.loadOrders(AppState.currentTrip.id);
                    Utils.showToast('Pedidos atualizados', 'success');
                }
            });
            
            // Order form
            document.getElementById('order-form').addEventListener('submit', (e) => {
                e.preventDefault();
                OrderFormManager.submitOrder();
            });
            
            document.getElementById('add-item-btn').addEventListener('click', () => {
                OrderFormManager.addItem();
            });
            
            document.getElementById('cancel-order').addEventListener('click', () => {
                OrderFormManager.closeModal();
            });
            
            // Close modal when clicking outside
            document.getElementById('order-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    OrderFormManager.closeModal();
                }
            });

            // Initialize Product Search Manager
            ProductSearchManager.initEvents();
        });

        // Make functions globally available
        window.TripManager = TripManager;
        window.OrderManager = OrderManager;
        window.OrderFormManager = OrderFormManager;
        window.ProductSearchManager = ProductSearchManager;
    </script>
</body>
</html>